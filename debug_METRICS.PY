#!/usr/bin/env python3
"""
Script de diagnostic pour dÃ©boguer le problÃ¨me des mÃ©triques Prometheus.
"""
import requests
import time

def test_metrics_endpoint_detailed():
    """Test dÃ©taillÃ© de l'endpoint des mÃ©triques."""
    print("ğŸ” DIAGNOSTIC DÃ‰TAILLÃ‰ DES MÃ‰TRIQUES")
    print("="*50)
    
    base_url = "http://localhost:8000"
    
    # Ã‰tape 1: VÃ©rifier que l'API rÃ©pond
    print("1. Test de connectivitÃ© de base...")
    try:
        response = requests.get(f"{base_url}/health", timeout=5)
        print(f"   âœ… API accessible (status: {response.status_code})")
    except Exception as e:
        print(f"   âŒ API non accessible: {e}")
        return False
    
    # Ã‰tape 2: GÃ©nÃ©rer quelques requÃªtes pour crÃ©er des mÃ©triques
    print("\n2. GÃ©nÃ©ration de requÃªtes pour crÃ©er des mÃ©triques...")
    endpoints_to_test = [
        ("/", "GET"),
        ("/health", "GET"),
        ("/models", "GET"),
        ("/test/prediction", "POST")
    ]
    
    for endpoint, method in endpoints_to_test:
        try:
            if method == "GET":
                resp = requests.get(f"{base_url}{endpoint}", timeout=5)
            else:
                resp = requests.post(f"{base_url}{endpoint}", timeout=5)
            print(f"   âœ… {method} {endpoint} -> {resp.status_code}")
        except Exception as e:
            print(f"   âŒ {method} {endpoint} -> {e}")
    
    # Ã‰tape 3: RÃ©cupÃ©rer et analyser les mÃ©triques
    print("\n3. RÃ©cupÃ©ration des mÃ©triques...")
    try:
        response = requests.get(f"{base_url}/metrics", timeout=10)
        print(f"   ğŸ“Š Status code: {response.status_code}")
        print(f"   ğŸ“Š Content-Type: {response.headers.get('content-type')}")
        
        if response.status_code == 200:
            metrics_text = response.text
            print(f"   ğŸ“Š Taille de la rÃ©ponse: {len(metrics_text)} caractÃ¨res")
            
            # Afficher les premiers caractÃ¨res
            print(f"\n4. Contenu des mÃ©triques (premiers 500 caractÃ¨res):")
            print("-" * 50)
            print(metrics_text[:500])
            print("-" * 50)
            
            # Chercher des mÃ©triques spÃ©cifiques
            print(f"\n5. Recherche de mÃ©triques spÃ©cifiques:")
            metrics_to_find = [
                "portfolio_api_requests_total",
                "portfolio_api_request_duration_seconds", 
                "portfolio_model_predictions_total",
                "portfolio_model_prediction_confidence",
                "portfolio_portfolio_value_dollars"
            ]
            
            found_metrics = []
            for metric in metrics_to_find:
                if metric in metrics_text:
                    found_metrics.append(metric)
                    print(f"   âœ… {metric}")
                    
                    # Afficher les lignes contenant cette mÃ©trique
                    lines = [line for line in metrics_text.split('\n') if metric in line and not line.startswith('#')]
                    for line in lines[:3]:  # Afficher les 3 premiÃ¨res occurrences
                        print(f"      â†’ {line.strip()}")
                else:
                    print(f"   âŒ {metric}")
            
            # Afficher toutes les mÃ©triques trouvÃ©es
            print(f"\n6. Toutes les mÃ©triques dÃ©tectÃ©es:")
            all_lines = metrics_text.split('\n')
            metric_lines = [line for line in all_lines if line and not line.startswith('#') and '=' in line]
            
            if metric_lines:
                print(f"   ğŸ“Š {len(metric_lines)} lignes de mÃ©triques trouvÃ©es:")
                for line in metric_lines[:10]:  # Afficher les 10 premiÃ¨res
                    print(f"      â†’ {line.strip()}")
                if len(metric_lines) > 10:
                    print(f"      ... et {len(metric_lines) - 10} autres")
            else:
                print("   âŒ Aucune ligne de mÃ©trique trouvÃ©e")
            
            return len(found_metrics) > 0
        else:
            print(f"   âŒ Erreur HTTP: {response.status_code}")
            print(f"   ğŸ“ RÃ©ponse: {response.text}")
            return False
            
    except Exception as e:
        print(f"   âŒ Erreur: {e}")
        return False

def test_prometheus_import():
    """Test l'import de Prometheus dans l'API."""
    print("\n7. Test de l'import Prometheus dans l'API...")
    
    try:
        # Importer directement ce que l'API utilise
        from prometheus_client import Counter, Histogram, generate_latest, CollectorRegistry
        print("   âœ… prometheus_client importÃ© avec succÃ¨s")
        
        # CrÃ©er un registre de test
        test_registry = CollectorRegistry()
        test_counter = Counter('test_counter', 'Test counter', registry=test_registry)
        test_counter.inc()
        
        # GÃ©nÃ©rer les mÃ©triques
        metrics_output = generate_latest(test_registry)
        print(f"   âœ… GÃ©nÃ©ration de mÃ©triques test rÃ©ussie ({len(metrics_output)} bytes)")
        
        if b'test_counter' in metrics_output:
            print("   âœ… MÃ©trique test trouvÃ©e dans la sortie")
            return True
        else:
            print("   âŒ MÃ©trique test non trouvÃ©e")
            return False
            
    except ImportError as e:
        print(f"   âŒ Import prometheus_client Ã©chouÃ©: {e}")
        return False
    except Exception as e:
        print(f"   âŒ Erreur test Prometheus: {e}")
        return False

def main():
    """Fonction principale de diagnostic."""
    print("ğŸš€ DIAGNOSTIC COMPLET DES MÃ‰TRIQUES PROMETHEUS")
    print("="*60)
    
    # Test 1: Import Prometheus
    prometheus_ok = test_prometheus_import()
    
    # Test 2: MÃ©triques API
    metrics_ok = test_metrics_endpoint_detailed()
    
    # RÃ©sumÃ©
    print("\n" + "="*60)
    print("ğŸ“‹ RÃ‰SUMÃ‰ DU DIAGNOSTIC")
    print("="*60)
    print(f"ğŸ”§ Import Prometheus: {'âœ… OK' if prometheus_ok else 'âŒ FAIL'}")
    print(f"ğŸ“Š MÃ©triques API: {'âœ… OK' if metrics_ok else 'âŒ FAIL'}")
    
    if prometheus_ok and not metrics_ok:
        print("\nğŸ’¡ DIAGNOSTIC:")
        print("   - Prometheus fonctionne localement")
        print("   - ProblÃ¨me dans l'intÃ©gration API")
        print("   - VÃ©rifiez que le middleware de mÃ©triques s'exÃ©cute")
        print("   - VÃ©rifiez que les mÃ©triques sont bien enregistrÃ©es")
        
        print("\nğŸ”§ SOLUTIONS SUGGÃ‰RÃ‰ES:")
        print("   1. RedÃ©marrer l'API")
        print("   2. VÃ©rifier les logs de l'API")
        print("   3. Tester manuellement avec curl")
        
    elif not prometheus_ok:
        print("\nğŸ’¡ DIAGNOSTIC:")
        print("   - ProblÃ¨me avec l'installation de prometheus_client")
        print("   - RÃ©installez: pip install prometheus-client")
        
    else:
        print("\nğŸ‰ MÃ©triques fonctionnelles!")
    
    return prometheus_ok and metrics_ok

if __name__ == "__main__":
    success = main()
    if not success:
        print("\nğŸ”— Ã‰TAPES DE DÃ‰BOGAGE SUPPLÃ‰MENTAIRES:")
        print("1. VÃ©rifiez les logs de l'API:")
        print("   - Recherchez des erreurs dans la console oÃ¹ l'API tourne")
        print("2. Testez manuellement:")
        print("   curl http://localhost:8000/metrics")
        print("3. RedÃ©marrez l'API et retestez")